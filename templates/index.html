<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Depth Pro - å•ç›®æ·±åº¦ä¼°è®¡</title>
    <style>
        :root {
            --bg: #0f172a; --card: #1e293b; --accent: #3b82f6; --text: #f1f5f9; --muted: #94a3b8;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: system-ui, sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        header { text-align: center; padding: 30px 0; border-bottom: 1px solid #334155; margin-bottom: 30px; }
        h1 { font-size: 2.5rem; background: linear-gradient(135deg, #3b82f6, #8b5cf6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .subtitle { color: var(--muted); margin-top: 10px; }
        .features { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0; }
        .feature { background: var(--card); padding: 15px; border-radius: 10px; text-align: center; }
        .feature-icon { font-size: 2rem; margin-bottom: 8px; }
        .feature-title { font-weight: 600; color: var(--accent); }
        .feature-desc { font-size: 0.85rem; color: var(--muted); margin-top: 5px; }
        .main-grid { display: grid; grid-template-columns: 300px 1fr; gap: 20px; }
        @media (max-width: 900px) { .main-grid { grid-template-columns: 1fr; } }
        .panel { background: var(--card); border-radius: 12px; padding: 20px; }
        .panel-title { font-size: 1.1rem; font-weight: 600; margin-bottom: 15px; display: flex; align-items: center; gap: 8px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; font-size: 0.9rem; color: var(--muted); margin-bottom: 5px; }
        select, input[type="file"] { width: 100%; padding: 10px; border: 1px solid #334155; border-radius: 8px; background: var(--bg); color: var(--text); }
        .upload-zone { border: 2px dashed #334155; border-radius: 12px; padding: 40px; text-align: center; cursor: pointer; transition: all 0.3s; }
        .upload-zone:hover, .upload-zone.dragover { border-color: var(--accent); background: rgba(59,130,246,0.1); }
        .upload-zone img { max-width: 100%; max-height: 200px; border-radius: 8px; margin-top: 10px; }
        .btn { width: 100%; padding: 12px; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .btn-primary { background: var(--accent); color: white; }
        .btn-primary:hover { background: #2563eb; }
        .btn-primary:disabled { background: #475569; cursor: not-allowed; }
        .btn-secondary { background: #334155; color: var(--text); margin-top: 10px; }
        .progress-bar { height: 4px; background: #334155; border-radius: 2px; margin: 15px 0; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--accent); width: 0%; transition: width 0.3s; }
        .status { text-align: center; color: var(--muted); font-size: 0.9rem; }
        .results { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        @media (max-width: 700px) { .results { grid-template-columns: 1fr; } }
        .result-img { width: 100%; border-radius: 8px; background: #000; }
        .stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 15px; }
        .stat { background: var(--bg); padding: 12px; border-radius: 8px; text-align: center; }
        .stat-value { font-size: 1.3rem; font-weight: 700; color: var(--accent); }
        .stat-label { font-size: 0.8rem; color: var(--muted); }
        .gpu-status { display: flex; align-items: center; gap: 10px; padding: 10px; background: var(--bg); border-radius: 8px; margin-top: 15px; }
        .gpu-dot { width: 10px; height: 10px; border-radius: 50%; background: #22c55e; }
        .gpu-dot.offline { background: #ef4444; }
        .download-btns { display: flex; gap: 10px; margin-top: 15px; }
        .download-btns a { flex: 1; padding: 10px; background: #334155; color: var(--text); text-decoration: none; border-radius: 8px; text-align: center; font-size: 0.9rem; }
        .download-btns a:hover { background: #475569; }
        .lang-select { position: absolute; top: 20px; right: 20px; }
        .tips { background: rgba(59,130,246,0.1); border-left: 3px solid var(--accent); padding: 15px; border-radius: 0 8px 8px 0; margin-top: 20px; }
        .tips-title { font-weight: 600; margin-bottom: 8px; }
        .tips ul { padding-left: 20px; color: var(--muted); font-size: 0.9rem; }
        .tips li { margin: 5px 0; }
        footer { text-align: center; padding: 30px; color: var(--muted); font-size: 0.85rem; margin-top: 40px; border-top: 1px solid #334155; }
        footer a { color: var(--accent); text-decoration: none; }
    </style>
</head>
<body>
    <select class="lang-select" id="langSelect" onchange="changeLang(this.value)">
        <option value="zh-CN">ç®€ä½“ä¸­æ–‡</option>
        <option value="en">English</option>
        <option value="zh-TW">ç¹é«”ä¸­æ–‡</option>
        <option value="ja">æ—¥æœ¬èª</option>
    </select>
    
    <div class="container">
        <header>
            <h1>ğŸ”¬ Depth Pro</h1>
            <p class="subtitle" data-i18n="subtitle">Apple å•ç›®æ·±åº¦ä¼°è®¡æ¨¡å‹ - 0.3ç§’ç”Ÿæˆé«˜ç²¾åº¦æ·±åº¦å›¾</p>
        </header>
        
        <div class="features">
            <div class="feature">
                <div class="feature-icon">âš¡</div>
                <div class="feature-title" data-i18n="f1-title">æé€Ÿæ¨ç†</div>
                <div class="feature-desc" data-i18n="f1-desc">2.25MP æ·±åº¦å›¾ä»…éœ€ 0.3 ç§’</div>
            </div>
            <div class="feature">
                <div class="feature-icon">ğŸ“</div>
                <div class="feature-title" data-i18n="f2-title">ç»å¯¹å°ºåº¦</div>
                <div class="feature-desc" data-i18n="f2-desc">è¾“å‡ºçœŸå®ç±³åˆ¶æ·±åº¦å€¼</div>
            </div>
            <div class="feature">
                <div class="feature-icon">ğŸ¯</div>
                <div class="feature-title" data-i18n="f3-title">è¾¹ç¼˜é”åˆ©</div>
                <div class="feature-desc" data-i18n="f3-desc">é«˜é¢‘ç»†èŠ‚ä¿ç•™å®Œæ•´</div>
            </div>
            <div class="feature">
                <div class="feature-icon">ğŸ“·</div>
                <div class="feature-title" data-i18n="f4-title">ç„¦è·ä¼°è®¡</div>
                <div class="feature-desc" data-i18n="f4-desc">è‡ªåŠ¨ä¼°ç®—ç›¸æœºç„¦è·</div>
            </div>
        </div>
        
        <div class="main-grid">
            <div class="panel">
                <div class="panel-title">âš™ï¸ <span data-i18n="params">å‚æ•°è®¾ç½®</span></div>
                
                <div class="form-group">
                    <label data-i18n="colormap">é¢œè‰²æ˜ å°„</label>
                    <select id="colormap">
                        <option value="turbo">Turbo (æ¨è)</option>
                        <option value="viridis">Viridis</option>
                        <option value="plasma">Plasma</option>
                        <option value="magma">Magma</option>
                        <option value="inferno">Inferno</option>
                    </select>
                </div>
                
                <div class="gpu-status">
                    <div class="gpu-dot" id="gpuDot"></div>
                    <div>
                        <div id="gpuName">GPU</div>
                        <div style="font-size:0.8rem;color:var(--muted)" id="gpuMem">-</div>
                    </div>
                </div>
                <button class="btn btn-secondary" onclick="offloadGPU()" data-i18n="release-gpu">é‡Šæ”¾æ˜¾å­˜</button>
                
                <div class="tips">
                    <div class="tips-title" data-i18n="tips-title">ğŸ’¡ ä½¿ç”¨æŠ€å·§</div>
                    <ul>
                        <li data-i18n="tip1">æ”¯æŒ JPG/PNG/HEIC æ ¼å¼</li>
                        <li data-i18n="tip2">é«˜åˆ†è¾¨ç‡å›¾åƒæ•ˆæœæ›´ä½³</li>
                        <li data-i18n="tip3">æ·±åº¦å€¼å•ä½ä¸ºç±³ (m)</li>
                        <li data-i18n="tip4">NPZ æ–‡ä»¶å¯ç”¨ NumPy è¯»å–</li>
                    </ul>
                </div>
            </div>
            
            <div class="panel">
                <div class="panel-title">ğŸ“¤ <span data-i18n="upload">ä¸Šä¼ å›¾åƒ</span></div>
                
                <div class="upload-zone" id="uploadZone" onclick="document.getElementById('fileInput').click()">
                    <div id="uploadText">
                        <div style="font-size:3rem;margin-bottom:10px">ğŸ“</div>
                        <div data-i18n="drop-hint">ç‚¹å‡»æˆ–æ‹–æ‹½å›¾åƒåˆ°æ­¤å¤„</div>
                    </div>
                    <img id="previewImg" style="display:none">
                </div>
                <input type="file" id="fileInput" accept="image/*" style="display:none" onchange="handleFile(this.files[0])">
                
                <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
                <div class="status" id="status" data-i18n="ready">å‡†å¤‡å°±ç»ª</div>
                
                <button class="btn btn-primary" id="processBtn" onclick="process()" disabled data-i18n="process">å¼€å§‹å¤„ç†</button>
                
                <div class="results" id="results" style="display:none;margin-top:20px">
                    <div>
                        <label data-i18n="original">åŸå›¾</label>
                        <img class="result-img" id="origImg">
                    </div>
                    <div>
                        <label data-i18n="depth-map">æ·±åº¦å›¾</label>
                        <img class="result-img" id="depthImg">
                    </div>
                </div>
                
                <div class="stats" id="statsPanel" style="display:none">
                    <div class="stat">
                        <div class="stat-value" id="minDepth">-</div>
                        <div class="stat-label" data-i18n="min-depth">æœ€è¿‘è·ç¦» (m)</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="maxDepth">-</div>
                        <div class="stat-label" data-i18n="max-depth">æœ€è¿œè·ç¦» (m)</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="focalLen">-</div>
                        <div class="stat-label" data-i18n="focal">ç„¦è· (px)</div>
                    </div>
                </div>
                
                <div class="download-btns" id="downloadBtns" style="display:none">
                    <a id="dlJpg" download data-i18n="dl-jpg">ğŸ“· ä¸‹è½½æ·±åº¦å›¾</a>
                    <a id="dlNpz" download data-i18n="dl-npz">ğŸ“Š ä¸‹è½½ NPZ æ•°æ®</a>
                </div>
            </div>
        </div>
        
        <footer>
            <p>Depth Pro by Apple | <a href="https://arxiv.org/abs/2410.02073" target="_blank">Paper</a> | <a href="/docs" target="_blank">API Docs</a></p>
        </footer>
    </div>
    
    <script>
        const i18n = {
            'zh-CN': {
                subtitle: 'Apple å•ç›®æ·±åº¦ä¼°è®¡æ¨¡å‹ - 0.3ç§’ç”Ÿæˆé«˜ç²¾åº¦æ·±åº¦å›¾',
                'f1-title': 'æé€Ÿæ¨ç†', 'f1-desc': '2.25MP æ·±åº¦å›¾ä»…éœ€ 0.3 ç§’',
                'f2-title': 'ç»å¯¹å°ºåº¦', 'f2-desc': 'è¾“å‡ºçœŸå®ç±³åˆ¶æ·±åº¦å€¼',
                'f3-title': 'è¾¹ç¼˜é”åˆ©', 'f3-desc': 'é«˜é¢‘ç»†èŠ‚ä¿ç•™å®Œæ•´',
                'f4-title': 'ç„¦è·ä¼°è®¡', 'f4-desc': 'è‡ªåŠ¨ä¼°ç®—ç›¸æœºç„¦è·',
                params: 'å‚æ•°è®¾ç½®', colormap: 'é¢œè‰²æ˜ å°„', 'release-gpu': 'é‡Šæ”¾æ˜¾å­˜',
                'tips-title': 'ğŸ’¡ ä½¿ç”¨æŠ€å·§', tip1: 'æ”¯æŒ JPG/PNG/HEIC æ ¼å¼', tip2: 'é«˜åˆ†è¾¨ç‡å›¾åƒæ•ˆæœæ›´ä½³',
                tip3: 'æ·±åº¦å€¼å•ä½ä¸ºç±³ (m)', tip4: 'NPZ æ–‡ä»¶å¯ç”¨ NumPy è¯»å–',
                upload: 'ä¸Šä¼ å›¾åƒ', 'drop-hint': 'ç‚¹å‡»æˆ–æ‹–æ‹½å›¾åƒåˆ°æ­¤å¤„', ready: 'å‡†å¤‡å°±ç»ª',
                process: 'å¼€å§‹å¤„ç†', processing: 'å¤„ç†ä¸­...', original: 'åŸå›¾', 'depth-map': 'æ·±åº¦å›¾',
                'min-depth': 'æœ€è¿‘è·ç¦» (m)', 'max-depth': 'æœ€è¿œè·ç¦» (m)', focal: 'ç„¦è· (px)',
                'dl-jpg': 'ğŸ“· ä¸‹è½½æ·±åº¦å›¾', 'dl-npz': 'ğŸ“Š ä¸‹è½½ NPZ æ•°æ®', done: 'å¤„ç†å®Œæˆ!'
            },
            'en': {
                subtitle: 'Apple Monocular Depth Estimation - 2.25MP depth map in 0.3s',
                'f1-title': 'Fast', 'f1-desc': '2.25MP depth in 0.3 sec',
                'f2-title': 'Metric', 'f2-desc': 'Real-world meter scale',
                'f3-title': 'Sharp', 'f3-desc': 'High-frequency details',
                'f4-title': 'Focal Est.', 'f4-desc': 'Auto focal length',
                params: 'Parameters', colormap: 'Colormap', 'release-gpu': 'Release GPU',
                'tips-title': 'ğŸ’¡ Tips', tip1: 'Supports JPG/PNG/HEIC', tip2: 'Higher resolution = better',
                tip3: 'Depth unit is meters', tip4: 'NPZ readable by NumPy',
                upload: 'Upload Image', 'drop-hint': 'Click or drag image here', ready: 'Ready',
                process: 'Process', processing: 'Processing...', original: 'Original', 'depth-map': 'Depth Map',
                'min-depth': 'Min Depth (m)', 'max-depth': 'Max Depth (m)', focal: 'Focal (px)',
                'dl-jpg': 'ğŸ“· Download JPG', 'dl-npz': 'ğŸ“Š Download NPZ', done: 'Done!'
            },
            'zh-TW': {
                subtitle: 'Apple å–®ç›®æ·±åº¦ä¼°è¨ˆæ¨¡å‹ - 0.3ç§’ç”Ÿæˆé«˜ç²¾åº¦æ·±åº¦åœ–',
                'f1-title': 'æ¥µé€Ÿæ¨ç†', 'f1-desc': '2.25MP æ·±åº¦åœ–åƒ…éœ€ 0.3 ç§’',
                'f2-title': 'çµ•å°å°ºåº¦', 'f2-desc': 'è¼¸å‡ºçœŸå¯¦ç±³åˆ¶æ·±åº¦å€¼',
                'f3-title': 'é‚Šç·£éŠ³åˆ©', 'f3-desc': 'é«˜é »ç´°ç¯€ä¿ç•™å®Œæ•´',
                'f4-title': 'ç„¦è·ä¼°è¨ˆ', 'f4-desc': 'è‡ªå‹•ä¼°ç®—ç›¸æ©Ÿç„¦è·',
                params: 'åƒæ•¸è¨­ç½®', colormap: 'é¡è‰²æ˜ å°„', 'release-gpu': 'é‡‹æ”¾é¡¯å­˜',
                'tips-title': 'ğŸ’¡ ä½¿ç”¨æŠ€å·§', tip1: 'æ”¯æŒ JPG/PNG/HEIC æ ¼å¼', tip2: 'é«˜åˆ†è¾¨ç‡åœ–åƒæ•ˆæœæ›´ä½³',
                tip3: 'æ·±åº¦å€¼å–®ä½ç‚ºç±³ (m)', tip4: 'NPZ æ–‡ä»¶å¯ç”¨ NumPy è®€å–',
                upload: 'ä¸Šå‚³åœ–åƒ', 'drop-hint': 'é»æ“Šæˆ–æ‹–æ‹½åœ–åƒåˆ°æ­¤è™•', ready: 'æº–å‚™å°±ç·’',
                process: 'é–‹å§‹è™•ç†', processing: 'è™•ç†ä¸­...', original: 'åŸåœ–', 'depth-map': 'æ·±åº¦åœ–',
                'min-depth': 'æœ€è¿‘è·é›¢ (m)', 'max-depth': 'æœ€é è·é›¢ (m)', focal: 'ç„¦è· (px)',
                'dl-jpg': 'ğŸ“· ä¸‹è¼‰æ·±åº¦åœ–', 'dl-npz': 'ğŸ“Š ä¸‹è¼‰ NPZ æ•¸æ“š', done: 'è™•ç†å®Œæˆ!'
            },
            'ja': {
                subtitle: 'Apple å˜çœ¼æ·±åº¦æ¨å®š - 0.3ç§’ã§é«˜ç²¾åº¦æ·±åº¦ãƒãƒƒãƒ—ç”Ÿæˆ',
                'f1-title': 'é«˜é€Ÿæ¨è«–', 'f1-desc': '2.25MP æ·±åº¦ãƒãƒƒãƒ—ã‚’0.3ç§’ã§',
                'f2-title': 'çµ¶å¯¾ã‚¹ã‚±ãƒ¼ãƒ«', 'f2-desc': 'å®Ÿéš›ã®ãƒ¡ãƒ¼ãƒˆãƒ«å˜ä½',
                'f3-title': 'ã‚·ãƒ£ãƒ¼ãƒ—', 'f3-desc': 'é«˜å‘¨æ³¢ãƒ‡ã‚£ãƒ†ãƒ¼ãƒ«ä¿æŒ',
                'f4-title': 'ç„¦ç‚¹è·é›¢æ¨å®š', 'f4-desc': 'è‡ªå‹•ç„¦ç‚¹è·é›¢æ¨å®š',
                params: 'ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿', colormap: 'ã‚«ãƒ©ãƒ¼ãƒãƒƒãƒ—', 'release-gpu': 'GPUè§£æ”¾',
                'tips-title': 'ğŸ’¡ ãƒ’ãƒ³ãƒˆ', tip1: 'JPG/PNG/HEICå¯¾å¿œ', tip2: 'é«˜è§£åƒåº¦æ¨å¥¨',
                tip3: 'æ·±åº¦å˜ä½ã¯ãƒ¡ãƒ¼ãƒˆãƒ«', tip4: 'NPZã¯NumPyã§èª­è¾¼å¯',
                upload: 'ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰', 'drop-hint': 'ã‚¯ãƒªãƒƒã‚¯ã¾ãŸã¯ãƒ‰ãƒ©ãƒƒã‚°', ready: 'æº–å‚™å®Œäº†',
                process: 'å‡¦ç†é–‹å§‹', processing: 'å‡¦ç†ä¸­...', original: 'å…ƒç”»åƒ', 'depth-map': 'æ·±åº¦ãƒãƒƒãƒ—',
                'min-depth': 'æœ€å°æ·±åº¦ (m)', 'max-depth': 'æœ€å¤§æ·±åº¦ (m)', focal: 'ç„¦ç‚¹è·é›¢ (px)',
                'dl-jpg': 'ğŸ“· JPGãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰', 'dl-npz': 'ğŸ“Š NPZãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰', done: 'å®Œäº†!'
            }
        };
        
        let currentLang = localStorage.getItem('lang') || 'zh-CN';
        let selectedFile = null;
        
        function changeLang(lang) {
            currentLang = lang;
            localStorage.setItem('lang', lang);
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (i18n[lang] && i18n[lang][key]) el.textContent = i18n[lang][key];
            });
            document.getElementById('langSelect').value = lang;
        }
        
        function handleFile(file) {
            if (!file) return;
            selectedFile = file;
            const reader = new FileReader();
            reader.onload = e => {
                document.getElementById('previewImg').src = e.target.result;
                document.getElementById('previewImg').style.display = 'block';
                document.getElementById('uploadText').style.display = 'none';
                document.getElementById('processBtn').disabled = false;
            };
            reader.readAsDataURL(file);
        }
        
        const zone = document.getElementById('uploadZone');
        zone.ondragover = e => { e.preventDefault(); zone.classList.add('dragover'); };
        zone.ondragleave = () => zone.classList.remove('dragover');
        zone.ondrop = e => { e.preventDefault(); zone.classList.remove('dragover'); handleFile(e.dataTransfer.files[0]); };
        
        async function process() {
            if (!selectedFile) return;
            const btn = document.getElementById('processBtn');
            const status = document.getElementById('status');
            const progress = document.getElementById('progressFill');
            
            btn.disabled = true;
            status.textContent = i18n[currentLang].processing;
            progress.style.width = '30%';
            
            const formData = new FormData();
            formData.append('file', selectedFile);
            formData.append('colormap', document.getElementById('colormap').value);
            
            try {
                progress.style.width = '60%';
                const res = await fetch('/api/predict', { method: 'POST', body: formData });
                const data = await res.json();
                progress.style.width = '100%';
                
                if (data.error) throw new Error(data.error);
                
                document.getElementById('origImg').src = document.getElementById('previewImg').src;
                document.getElementById('depthImg').src = 'data:image/jpeg;base64,' + data.depth_image_base64;
                document.getElementById('minDepth').textContent = data.min_depth_m.toFixed(2);
                document.getElementById('maxDepth').textContent = data.max_depth_m.toFixed(2);
                document.getElementById('focalLen').textContent = data.focal_length_px ? data.focal_length_px.toFixed(0) : 'N/A';
                document.getElementById('dlJpg').href = data.download_jpg;
                document.getElementById('dlNpz').href = data.download_npz;
                
                document.getElementById('results').style.display = 'grid';
                document.getElementById('statsPanel').style.display = 'grid';
                document.getElementById('downloadBtns').style.display = 'flex';
                status.textContent = i18n[currentLang].done;
            } catch (e) {
                status.textContent = 'Error: ' + e.message;
            }
            btn.disabled = false;
            setTimeout(() => progress.style.width = '0%', 1000);
        }
        
        async function updateGPU() {
            try {
                const res = await fetch('/api/gpu/status');
                const data = await res.json();
                const dot = document.getElementById('gpuDot');
                dot.className = 'gpu-dot' + (data.model_loaded ? '' : ' offline');
                if (data.gpu && data.gpu.name) {
                    document.getElementById('gpuName').textContent = data.gpu.name;
                    document.getElementById('gpuMem').textContent = `${data.gpu.memory_used.toFixed(1)} / ${data.gpu.memory_total.toFixed(1)} GB`;
                }
            } catch (e) {}
        }
        
        async function offloadGPU() {
            await fetch('/api/gpu/offload', { method: 'POST' });
            updateGPU();
        }
        
        changeLang(currentLang);
        updateGPU();
        setInterval(updateGPU, 5000);
    </script>
</body>
</html>
